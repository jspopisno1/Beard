<!DOCTYPE html>
<!--Sample inspired by Backbone Todos sample: http://documentcloud.github.com/backbone/examples/todos/index.html -->
<html>
    <head>
        <title>JsViews Demo: Todos</title>
        <script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
        <script src="../js/Beard.js" type="text/javascript"></script>
        <link href="http://borismoore.github.com/jsviews/demos/resources/todos.css" rel="stylesheet" type="text/css" />
    </head>
    <body>

        <div id="todoapp">
            <h1>Todos - Beard, Plain Objects</h1>

            <input id="new-todo" placeholder="What needs to be done?"/>

            <ul id="todo-list"></ul>

            <div id="todo-stats"></div>
        </div>
        <div beard="TodoApp">
            <div beard="TodoItem" bdatabind bargs="item, mode">
                <!--@
                   [`` t[mode](item); `]
                @-->
                <div beard="Edit">
                    <!--@
                    <li class="editing">
                        <input value='[`/ d.content `]' class="todo-input"/>
                    </li>
                    @-->
                </div>
                <div beard="Load">
                    <!--@
                    <li>
                        <input [`` d.done? 'checked': '' `] class="check" type="checkbox" />
                        <div style="[`` d.done? 'text-decoration:line-through': '' `]" class="todo-content">
                            [`/ d.content? d.content : 'empty todo item' `]
                        </div>
                        <span class="todo-destroy"></span>
                    </li>
                    @-->
                </div>
            </div>
            <div beard="Stats" bargs="remaining, completed">
                <!--@
		<span>[`` remaining ? ( remaining + " item" + ( remaining > 1 ? "s" : "" ) + " left" ) : "" `]</span>
                [## if(completed) { #]
		<a href="#" class="todo-clear">
                   [`` completed ? ( "Clear " + completed + " completed item" + ( completed > 1 ? "s" : "" )) : ""; `]
                </a>
                [## } #]
                @-->
            </div>
        </div>
        <ul id="instructions">
            <li>Todos: enter to add, double-click to edit...</li>
        </ul>


        <script>
            (function(){
                Beard.init({debug: false}).load();

                var todos = [];
                for(var i = 0; i < 500; i ++){
                    todos.push({done: i % 3?false:true, content : ' todo task ' + i});
                }

                Todos = {
                    items: todos,
                    clearData: function( clearCompleted, skipSave ) {
                        var l = Todos.items.length;
                        var completed = 0;
                        while ( l-- ) {
                            if ( Todos.items[ l ]._remove ||
                                clearCompleted && Todos.items[ l ].done ) {
                                Todos.items.splice(l, 1);
                                continue;
                            }
                            if(Todos.items[l].done){
                                completed ++;
                            }
                        }
                        Todos.remaining = Todos.items.length - completed;
                        Todos.completed = completed;
                        if(!skipSave) Todos.save();
                        return this;
                    },
                    save: function(){
                        localStorage.setItem( "JsViewsTodos", JSON.stringify( this.items ));
                        return this;
                    },
                    num: function(completedChange){
                        if(completedChange)
                            this.completed += completedChange;
                        this.remaining = Todos.items.length - this.completed;
                        return this;
                    },
                    refresh: function(){
                        Todos.$list.html('');
                        Beard.utils.loop(this.items, function(item){
                            Todos.$list.append(Todos.tpls.TodoItem.$(item,
                            item._mode=='Edit'?'Edit':'Load'));
                        })
                        Todos.$stats.html(Todos.tpls.Stats(Todos.remaining, Todos.completed));
                        return this;
                    },
                    $list : $('#todo-list'),
                    $stats : $('#todo-stats'),
                    tpls: Btpls.TodoApp
                }
                Todos.clearData().refresh(true);

                Todos.events = {
                    ':#todoapp': {
                        '#new-todo': {
                            '@keypress:bind': function(ev){
                                // create new todo
                                if ( ev.keyCode === 13 ){
                                    var items = Todos.items;
                                    items.push({index: items.length, content: this.value, done: false})
                                    this.value = "";
                                    Todos.num().save().refresh();
                                }
                            }
                        },
                        '.todo-clear@click':function() {
                            // clear all completed
                            Todos.clearData(true).refresh();
                        },
                        ':#todo-list': {
                            '.todo-destroy@click': function() {
                                // destroy a todo
                                var node = $(this).nodeUp();
                                node.item._remove = true;
                                Todos.num(node.item.done?-1:0).clearData().refresh();
                            },
                            'li@dblclick': function( ) {
                                // edit a todo
                                var node = $(this).nodeUp();
                                node.item._mode = 'Edit';
                                Todos.refresh();
                            },
                            'input@keypress':function( ev ) {
                                if (ev.keyCode === 13){
                                    // save an edit
                                    var node = $(this).nodeUp();
                                    node.item.content = this.value;
                                    node.item._mode = 'Load';
                                    Todos.save().refresh();
                                }
                            },
                            '.check': function(){
                                // done or un-done a todo
                                var n = $(this).nodeUp();
                                n.item.done = this.checked;
                                Todos.num(n.item.done?1:-1).save().refresh();
                            }
                        }
                    }
                    // end of Todo events
                }
                
                Beard.initEvents(Todos.events);
                window.Todos = Todos;

            })();
        </script>
    </body>
</html>
