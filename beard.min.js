(function(g,d,undefined){function compileTemplate(a,b,c){var d=a;if(c){c+=", _e_"}else{c="d, _e_"}utils.log(d);utils.loop(tplTags,function(a,b){d=d.split(b).join(a)});d=d.split(ec);var e="o[o.length]='";var f="o[o.length]=tagFunc('";var g="o[o.length]=esc(";var h="o[o.length]=";var i="u._log(e.message + ' @ ";var j=[];for(var k=0,l=d.length;k<l;k++){var m=d[k];if(m.charAt(1)!==E){j.push(e,m.replace(/^\s\s*/," ").replace(/\s\s*$/," ").replace(/(\\|')/g,"\\$1").split("\n").join("\\n"),"';\n")}else{var n=m.charAt(0);m=m.substr(2);if(n=="o"){j.push(m.substr(1),"\n")}else{if(safeMode){j.push("try{")}switch(n){case"t":var o=rgxTagName.exec(m);if(o){var p=o[0];var q=m.substr(p.length);j.push(f,$.trim(p).replace(/(\\|')/g,"\\$1").split("\n").join("\\n"),"')",$.trim(q)==""?"()":q,isDebug?';log("  ----- LOC -----  "+  '+locIndex++ +"  +'"+m.replace(/(\\|')/g,"\\$1").split("\n").join("\\n")+"');\n":";\n")}break;case"q":j.push(h,m,isDebug?';log("  ----- LOC -----  "+   ('+locIndex++ +")   +'"+m.replace(/(\\|')/g,"\\$1").split("\n").join("\\n")+" =>',"+m+");\n":";\n");break;case"s":j.push(g,m,isDebug?');log("  ----- LOC -----  "+   ('+locIndex++ +")   +'"+m.replace(/(\\|')/g,"\\$1").split("\n").join("\\n")+"',"+m+");\n":");\n");break}if(safeMode){j.push("}catch(e){",isDebug?i+m.replace(/(\\|')/g,"\\$1").split("\n").join("\\n")+"')}\n":"}\n")}else{j.push("\n")}}}}j=j.join("").split(["o[o.length]='';\n"].join("")).join("").replace(/try{}catch\(e\){.*?}\n/g,"");j=["var e=_e_||{};var u=Beard.utils,o=[],t=arguments.callee;function out(){o.push.apply(","o, arguments);}function tag(tag, data){out(u.tagFunc(tag)(data))}",compileUtils(b,c),"try{",j,';return o.join("");}catch(e){u.log(arguments.callee.toString());log(e);throw e;}'].join("");try{var r=new Function(c,j);if(isDebug){utils.log("---- SUCCESS: The compiled function for template <<"+b+">> : ---- \n\n");utils.log(r.toString())}return r}catch(s){s.msg="The template cannot be compiled.";s.funcString=j;utils.log("---- FAILED: The compiled function for template <<"+b+">> : ---- \n\n","function(){"+j+"}");throw s}}function compileUtils(a,b){var c=["/**/\nif(u._edit>",utils._edit,'){return Beard._recompileTemplate(t, "',a,'", "',b,'", ',b,")}"];utils.loop(utils,function(a,b){if(b.charAt(0)!=UNDERSCORE){c.push("\nfunction ",b,"(){return u.",b,".apply(u, arguments)}")}});c.push("/**/");return c.join("")}function getTplFunction(a,b,c,d,e,f){if(!d){d=a.split(".");e=0;f=d.length;c=Btpls;b=b?1:0;for(var g=0,h=d.length;g<h;g++){d[g]=d[g].charAt(0).toUpperCase()+d[g].slice(1)}a=d.join(".");if(tplsByPath[a]){if(b){return tplsByPath[a].__parent}else{return tplsByPath[a]}}}if(e==f-b){return c}var i=d[e];if(i in c){return getTplFunction(a,b,c[i],d,e+1,f)}else{var j=c[i]=function(){throw new Error(a+" : Not implemented yet")};c.__tpls__[i]=1;j.__tpls__={};j.tags={};j.__parent=c;if(c.__path){j.__path=c.__path+"."+i}else{j.__path=i}tplsByPath[j.__path]=j;return getTplFunction(a,b,j,d,e+1,f)}}function pushFunction(a,b,c,d){var e=getTplFunction(a,true);b=b.charAt(0).toUpperCase()+b.slice(1);if(e[b]){var f=removeRef(e,b);if(!f){if(d){removeAllRef(e[b])}renewRefbys(e[b].__path,c)}}if(e.__path){a=e.__path+"."+b}else{a=b}if(!d){var g=e[b];if(g&&!f){var h=c.__tpls__=g.__tpls__;for(var i in h){if(h.hasOwnProperty(i)){c[i]=g[i];g[i].__parent=c}}c.tags=g.tags;c.__path=g.__path}else{c.__tpls__={};c.tags={};c.__path=a}c.__parent=e;tplsByPath[c.__path]=c}else{tplsByPath[a]=c;addRef(e,b,c)}e[b]=c;e.__tpls__[b]=1}function addRef(a,b,c){var d=a.__path;var e=c.__path;if(!reftos[d]){reftos[d]={len:0}}var f=reftos[d];f[b]=e;f.len++;if(!refbys[e]){refbys[e]={len:0}}f=refbys[e];if(!f[d]){f.len++;f[d]={len:0}}f=f[d];f[b]=1;f.len++}function removeAllRef(a){for(var b in a.__tpls__){var c=removeRef(a,b);if(!c){removeAllRef(a[b]);var d=a[b].__path;var e=function(){throw new Error(d+" : Not implemented yet")};e.__path=d;delete tplsByPath[d];renewRefbys(d,e)}}}function renewRefbys(a,b){if(refbys[a]){var c=refbys[a];for(var d in c){if(d!="len"&&c.hasOwnProperty(d)){var e=c[d];for(var f in e){var g=getTplFunction(d);if(f!="len"&&e.hasOwnProperty(f)){g[f]=b}}}}}}function removeRef(a,b){var c=false;var d=a.__path;if(reftos[d]){var e=reftos[d];if(e[b]){c=removeRefTo(d,b);if(c){removeRefBy(d,b,c)}}}return c}function removeRefBy(a,b,c){delete refbys[c][a][b];refbys[c][a].len--;if(!refbys[c][a].len){delete refbys[c][a];refbys[c].len--;if(!refbys[c].len){delete refbys[c]}}}function removeRefTo(a,b){var c=false;if(reftos[a]){var d=reftos[a];if(d[b]){c=d[b];delete d[b];d.len--;if(!d.len){delete reftos[a]}}}return c}function _load(a,b){var c=a?$("["+BEARD_REMOTE+"]"):$beard.find("["+BEARD_REMOTE+"]");c.each(function(){var c=$(this);var d=c.attr(BEARD_REMOTE);if(d in b){utils._log(d+" has been loaded.");return true}b[d]=1;queueRequest++;c.removeAttr(BEARD_REMOTE);$.ajax({url:d,dataType:"text",complete:function(){queueRequest--;if(queueRequest==0)_load(a,b)},success:function(a){c.html(a)}})});if(queueRequest==0){var d=a?$("div["+BEARD_NODE+"]"):$beard.find("div["+BEARD_NODE+"]");var e=[];var f={};d.each(function(){var a=$(this);var b=a.attr(BEARD_PATH);var c=a.attr(BEARD_NODE);if(typeof b!="string")b="";var d=b.split(":");if(1 in d){b=f[d[0]]+d[1]}d=c.split("$");if(1 in d){c=d[0]}if(!b){var e=a.parent().closest("["+BEARD_NODE+"]");var g=e.data("beard-path");b=(g?g+".":"")+c}else{b=(b?b+".":"")+c}if(1 in d){f[d[1]]=b}a.data("beard-path",b);a.data("beard-name",c);var h=a.attr(BEARD_REF);if(typeof h=="string"){d=h.split(":");if(1 in d){h=f[d[0]]+d[1]}d=h.split("$");if(1 in d){h=d[0];f[d[1]]=h}}a.data("beard-ref",h)}).each(function(){var a=$(this);var b=a.attr(BEARD_SHOW);if(b!==undefined&&b!==false){a.css("display","");a.removeAttr(BEARD_SHOW)}a.removeAttr(BEARD_NODE).removeAttr(BEARD_PATH).removeAttr(BEARD_REMOTE);a.appendTo($beard);e.push(a[0])});$.each(e,function(){var a=$(this);var b=a.data("beard-path");var c=a.data("beard-name");var d=a.data("beard-ref");if(typeof d=="string"){if(isDebug){utils.log(" --------------- PARSING REF ------------- "+b+" --to--> "+d)}var e=getTplFunction(d)}else{var f=a.attr(BEARD_ARGS);var g=a.html().replace(/<!--@\s*|@-->\s*/g,"").split("<").join("<").split(">").join(">").split("&").join("&");e=compileTemplate(g,b,f)}pushFunction(b,c,e,d)});$beard.html("");while(true){var g=operationQueue.shift();if(g){g()}else{break}}_ready()}}function _ready(){if(queueRequest>0||!isDocReady){return}while(true){var a=readyFuncs.shift();if(a){a()}else{break}}}if(!g.$){var e=new Error("jQuery must be loaded before Beard.js");throw e}var VERSION="0.1";var $beard;$(d).ready(function(){$beard=$("#"+BEARD_ZONE);if($beard.size()==0){$beard=$('<div id="'+BEARD_ZONE+'"></div>').appendTo("body")}$beard.css("display","none");isDocReady=true});(function(){function a(){$.fn.extend({beardData:function(){return this.data("beard-data")},bAfter:function(a){var b=$(a);this.after(b);Beard.bindData(b)},bBefore:function(a){var b=$(a);this.before(b);Beard.bindData(b)},bPrepend:function(a){var b=$(a);this.prepend(b);Beard.bindData(b)},bAppend:function(a){var b=$(a);this.append(b);Beard.bindData(b)},bReplace:function(a){var b=$(a);this.after(b).remove();Beard.bindData(b)},bHtml:function(a){this.html(a);Beard.bindData(this)}})}a()})();var BEARD_NODE,BEARD_PATH,BEARD_UNWRAP,BEARD_REMOTE,BEARD_SHOW,BEARD_ZONE="beards",BEARD_DATA,BEARD_ARGS,ARRAY="array",OBJECT="object",engineName,_options={},defOpts={codeOpen:"[##",codeClose:"#]",equaOpen:"[``",escapeOpen:"[`/",tagOpen:"[`:",equaClose:"`]",nodeDef:"beard",nodePath:"bpath",nodeUnwrap:"bunwrap",nodeRemote:"bremote",nodeData:"bdata",nodeShow:"bshow",nodeArgs:"bargs",nodeRef:"bref",nodeDel:"bdel",beardZone:"beards",withinZone:false,funcPre:"",debug:false,safemode:true,engine:"beard"},isDebug=false,safeMode=true,$debug,locIndex=0,canLog=typeof console!="undefined"&&typeof console.log=="function",tplTags,ec,cmpLength=function(a,b){if(a.length>b.length)return-1;else if(a.length==b.length)return 0;else return 1},E="",EE=E+E,EEE=EE+E,EEEE=EEE+E,rgxTagName=/^[^\(]+/,Btpls=g.Btpls={__tpls__:[],defineTag:function(a){Beard.defineTag(a);return Btpls}},emptyFunc=function(){return""},STRING="string",FUNCTION="function",firstRun=true,readyFuncs=[],queueRequest=0,operationQueue=[],tpls={},definedTags={},isDocReady=false,objCache={},objSeq=1,tagFuncCache={},hasDataCached=false,__beard_temp_func__;var Beard={version:VERSION,__tpls:tpls,load:function(a){if(queueRequest>0){return Beard}if(!engineName){Beard.init()}if(a)Beard.ready(a);var b={};_load(firstRun,b);firstRun=true;return Beard},loadRemote:function(a,b){if(b&&b.callback){Beard.ready(b.callback);delete b.callback}if(queueRequest>0){operationQueue.push(function(){Beard.loadRemote(a,b)});return Beard}if(b){var c=b.isScript;var d=b.path;var e=b.data}if(c&&!d){var f=new Error("A path is required for a template string");throw f}$.get(a,e,function(a){if(c){Beard.loadScript(a,d)}else{Beard.loadHtml(a,d)}},"text");return Beard},loadHtml:function(a,b,c){if(c){Beard.ready(c);delete c}if(queueRequest>0){operationQueue.push(function(){Beard.loadHtml(a,b,c)});return Beard}$beard.html(a);if(b){$beard.find("["+BEARD_PATH+"]").each(function(){var a=$(this);a.attr(BEARD_PATH,b+a.attr(BEARD_PATH))});$beard.find("["+BEARD_NODE+"]:not(["+BEARD_PATH+"])").each(function(){$(this).attr(BEARD_PATH,b)})}this.load();return Beard},loadScript:function(a,b){if(queueRequest>0){operationQueue.push(function(){Beard.loadScript(a,b)});return Beard}if(!engineName){Beard.init()}var c=compileTemplate(a,b);if(!b){return c}var d=b.split(".");pushFunction(b,d[d.length-1],c);return Beard},init:function(a){_options=$.extend({},defOpts,_options,a);isDebug=_options.debug;engineName=_options.engine;if(_options.beardZone!=BEARD_ZONE){BEARD_ZONE=_options.beardZone;if($beard){$beard.attr("id",BEARD_ZONE)}else{$beard=$('<div id="'+BEARD_ZONE+'"></div>').appendTo("body");$beard.css("display","none")}}firstRun=!_options.withinZone;BEARD_NODE=_options.nodeDef;BEARD_PATH=_options.nodePath;BEARD_UNWRAP=_options.nodeUnwrap;BEARD_REMOTE=_options.nodeRemote;BEARD_SHOW=_options.nodeShow;BEARD_DATA=_options.nodeData;BEARD_ARGS=_options.nodeArgs;BEARD_REF=_options.nodeRef;funcPre=_options.funcPre;ec=_options.equaClose;tplTags={};tplTags[_options.codeOpen]=ec+"o"+E;tplTags[_options.equaOpen]=ec+"q"+E;tplTags[_options.escapeOpen]=ec+"s"+E;tplTags[_options.tagOpen]=ec+"t"+E;tplTags[_options.codeClose]=ec;tplTags["_seq"]=[_options.codeOpen,_options.equaOpen,_options.escapeOpen,_options.tagOpen,_options.codeClose];tplTags._seq.sort(cmpLength);safeMode=_options.safemode;return Beard},extendUtils:function(a){utils._edit++;$.extend(utils,a);return Beard},defineTag:function(a){if(queueRequest>0){operationQueue.push(function(){Beard.defineTag(a)})}$.extend(definedTags,a);Beard.clearTagCache(a);return Beard},clearTagCache:function(a){if(a){if(a instanceof Array){utils.loop(a,function(a){delete tagFuncCache[a]})}else{utils.loop(a,function(a,b){delete tagFuncCache[b]})}}else{tagFuncCache={}}},ready:function(a){if(queueRequest==0&&isDocReady&&engineName){a()}else{readyFuncs.push(a)}return Beard},bindData:function(a){if(hasDataCached){if(!a){a=$("body")}var b="["+BEARD_DATA+"]";a.find(b).add(a.filter(b)).each(function(){var a=$(this);a.data("beard-data",objCache[a.attr(BEARD_DATA)]).removeAttr(BEARD_DATA)});Beard.clearData()}return Beard},bindDataOnly:function(){$("["+BEARD_DATA+"]").each(function(){var a=$(this);a.data("beard-data",objCache[a.attr(BEARD_DATA)]).removeAttr(BEARD_DATA)});return Beard},clearData:function(){objCache={};hasDataCached=false;return Beard},_recompileTemplate:function(templateFunc,path,args){var pts=templateFunc.toString().split("/**/");var F=eval(["__beard_temp_func__=",pts[0],compileUtils(path,args),pts[2]].join(""));pushFunction(path,F);if(isDebug)utils.log("Recompiling "+path);var fArgs=[];for(var i=3,len=arguments.length;i<len;i++){fArgs.push(arguments[i])}return F.apply(this,fArgs)}};var reftos={},refbys={},tplsByPath={};var UNDERSCORE="_";var extra={objId:function(a,b){if(a!==null&&a!==undefined){if(typeof a=="object"||typeof a=="function"){if(a.__objid_){var c=a.__objid_}else{c=a.__objid_=objSeq++}if(!(c in objCache)&&!b)objCache[c]=a}else{c=objSeq++;objCache[c]=a}hasDataCached=true;return c}else{return""}}};var utils=Beard.utils={_edit:0,esc:function(a){if(a!==null&&a!==undefined){return a.toString().split("&").join("&").split("<").join("<").split(">").join(">").split("'").join("&#39;").split('"').join("&#34;")}else{return""}},_log:function(a){if(isDebug){utils.log.apply(this,arguments)}},log:function(a){if(!isDebug&&!canLog)return;if(canLog){console.log.apply(console,arguments)}else{if(!$debug){$debug=$('<div id="debug"></div>');$("body").append($debug)}if(a){$("<div></div>").appendTo($debug)[0].innerText="\n"+a.toString()}}},tagFunc:function(a){if(a in definedTags){var b=definedTags[a];if(typeof b==STRING){if(a in tagFuncCache){return tagFuncCache[a]}else{return tagFuncCache[a]=this._getGlobalTagFunc(b.split("."),0,b,a)}}else if(typeof b==FUNCTION){return b}else{utils._log(a+' is found in defined tags as "'+b+'", but it is not a valid callable object.');return emptyFunc}}else{utils._log(a+" is not a defined tag.");return emptyFunc}},_getGlobalTagFunc:function(a,b,c,d,e,f){if(!f){f=a.length;e=g}if(e==null){utils._log(d+' is found in defined tags as "'+c+'", but it is not found in the global context.')}if(b==f){if(e)return e;else{utils._log(d+' is found in defined tags as "'+c+'", but it is not found in the global context.');return emptyFunc}}return this._getGlobalTagFunc(a,b+1,c,d,e[a[b]],f)},loop:function(a,b,c,d,e){f=0;if(typeof b!="function"||a===null||a===e){return false}if(c==ARRAY||a instanceof Array){for(var f=0,g=a.length;f<g;f++){var h=b(a[f],f,a,d);if(h!==e&&h!==true)return{ret:h,num:f}}}else if(c==OBJECT||a&&typeof a==OBJECT){if(a._seq){var i=a._seq;for(f=0,g=i.length;f<g;f++){var j=i[f];h=b(a[j],j,a,d);if(h!==e&&h!==true)return{ret:h,num:f,key:j}}}else{for(var k in a){if(a.hasOwnProperty(k)){h=b(a[k],k,a,d);if(h!==e&&h!==true)return{ret:h,num:f,key:k};f++}}}}else{f=-1;b(a,null,a,d)}return f},is:function(a){if(!a){return false}else{if(a instanceof Array&&a.length==0){return false}else if(typeof a=="object"){if(a._seq instanceof Array&&a._seq.length==0){return false}else{for(var b in a){if(a.hasOwnProperty(b)){return true}}return false}}return true}},search:function(a,b){if(a===undefined||a===null||a===false){return false}if(typeof a!="string"){return false}return a.indexOf(b)+1},partial:function(a,b,c,d){if(!c)c={};utils.loop(b,function(b,e){if(typeof e=="number"){c[b]=a[b];if(d){delete a[b]}}else{c[e]=a[b];if(d){delete a[b]}}});return c},strcat:function(){var a=[];for(var b=0,c=arguments.length;b<c;b++){a.push(arguments[b])}return a.join("")}};g.Beard=Beard})(window,document)

